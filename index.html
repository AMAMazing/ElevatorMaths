<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mental Math Master</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Fira+Code:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        .font-mono { font-family: 'Fira Code', monospace; }

        /* Animations */
        .fade-enter-active { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Multiplier Pulse */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px currentColor; }
            50% { box-shadow: 0 0 25px currentColor; }
        }
        .multiplier-pulse { animation: pulse-glow 2s infinite; }

        /* Chaos Glitch Effect */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .chaos-text { animation: glitch 0.3s infinite linear; animation-play-state: paused; }
        .chaos-active .chaos-text { animation-play-state: running; }

        /* Binary Switches */
        .bit-switch {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        .bit-on {
            background-color: #4ade80; 
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.4), inset 0 2px 0 rgba(255,255,255,0.3);
            border-color: #22c55e; color: #064e3b; transform: translateY(1px);
        }
        .bit-off {
            background-color: #1f2937; border-color: #374151; color: #4b5563;
            box-shadow: 0 4px 0 #111827; transform: translateY(-2px);
        }
        .bit-off:active { transform: translateY(1px); box-shadow: 0 0 0 #111827; }

        /* UI Utilities */
        .hint-overlay {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(4px);
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="w-full p-4 flex justify-between items-center bg-gray-800 shadow-md z-20 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <div class="text-xl font-bold tracking-tight text-indigo-400 cursor-pointer" onclick="location.reload()">
                üß† MentalMath<span class="text-white">Master</span>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="app.toggleHistory()" class="p-2 text-gray-400 hover:text-white transition rounded-lg hover:bg-gray-700" title="History">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <button id="fullscreen-btn" class="p-2 text-gray-400 hover:text-white transition rounded-lg hover:bg-gray-700" title="Fullscreen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                </svg>
            </button>
            <button id="exit-btn" class="hidden text-sm font-medium text-gray-400 hover:text-white transition flex items-center gap-1 pl-2 border-l border-gray-600">
                Exit
            </button>
        </div>
    </nav>

    <main class="flex-grow flex items-center justify-center p-4 w-full max-w-2xl mx-auto relative z-10">
        
        <!-- VIEW: MENU -->
        <div id="menu-view" class="w-full space-y-8 text-center fade-enter-active">
            <div>
                <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-indigo-400 mb-2">
                    Train Your Brain
                </h1>
                <div id="menu-pb" class="text-sm font-mono text-emerald-400 bg-emerald-900/30 inline-block px-3 py-1 rounded-full border border-emerald-500/30">
                    PB: 0
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Career -->
                <button onclick="app.startCareer()" class="group relative bg-gray-800 hover:bg-indigo-900/40 border border-gray-700 hover:border-indigo-500 rounded-xl p-6 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl flex flex-col items-center">
                    <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">üèÜ</div>
                    <h3 class="text-xl font-bold text-white mb-2">Career</h3>
                    <p class="text-xs text-gray-400">Streak building.</p>
                </button>

                <!-- Practice -->
                <button onclick="app.showPracticeMenu()" class="group relative bg-gray-800 hover:bg-emerald-900/40 border border-gray-700 hover:border-emerald-500 rounded-xl p-6 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl flex flex-col items-center">
                    <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">üéØ</div>
                    <h3 class="text-xl font-bold text-white mb-2">Practice</h3>
                    <p class="text-xs text-gray-400">Target specific skills.</p>
                </button>

                <!-- Timed Run -->
                <button onclick="app.startTimed()" class="group relative bg-gray-800 hover:bg-orange-900/40 border border-gray-700 hover:border-orange-500 rounded-xl p-6 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl flex flex-col items-center">
                    <div class="absolute top-3 right-3 text-xs bg-orange-500 text-black font-bold px-2 py-0.5 rounded">5 MIN</div>
                    <div class="text-4xl mb-4 group-hover:scale-110 transition-transform">‚ö°</div>
                    <h3 class="text-xl font-bold text-white mb-2">High Stakes</h3>
                    <p class="text-xs text-gray-400">Multipliers. All Modes.</p>
                </button>
            </div>
        </div>

        <!-- VIEW: PRACTICE SELECTOR -->
        <div id="practice-view" class="hidden w-full text-center fade-enter-active">
            <h2 class="text-2xl font-bold mb-4 text-gray-300">Select Module</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 h-[60vh] overflow-y-auto custom-scroll pr-1">
                <button onclick="app.startPractice(1)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Arithmetic</button>
                <button onclick="app.startPractice(2)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Complex Ops</button>
                <button onclick="app.startPractice(3)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Fractions / %</button>
                <button onclick="app.startPractice(4)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Algebra</button>
                <button onclick="app.startPractice(5)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Sequences</button>
                <button onclick="app.startPractice(8)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Modulo (%)</button>
                <button onclick="app.startPractice(9)" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 border border-gray-700 text-sm">Is it Prime?</button>
                <button onclick="app.startPractice(10)" class="p-4 bg-gray-800 rounded-lg hover:bg-purple-900/30 border border-purple-500/30 text-purple-300 text-sm">Chaos Mode</button>
                
                <div class="col-span-2 md:col-span-1 grid grid-cols-1 gap-2">
                     <button onclick="app.startPractice(6)" class="p-2 bg-gray-800 rounded-lg border border-indigo-500/30 text-indigo-300 text-xs">Read Binary</button>
                     <button onclick="app.startPractice(7)" class="p-2 bg-gray-800 rounded-lg border border-indigo-500/30 text-indigo-300 text-xs">Write Binary</button>
                </div>
            </div>
            <button onclick="app.goHome()" class="mt-6 text-gray-500 hover:text-white transition">Back to Menu</button>
        </div>

        <!-- VIEW: GAME -->
        <div id="game-view" class="hidden w-full max-w-md fade-enter-active">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 min-h-[420px] flex flex-col justify-between relative overflow-hidden border border-gray-700">
                
                <!-- Game Header -->
                <header class="flex justify-between items-center mb-6 h-8 relative z-10">
                    <div class="flex items-center gap-2">
                        <span id="game-info-left" class="text-sm font-bold uppercase tracking-wider text-gray-400">Level 1</span>
                        <div id="multiplier-badge" class="hidden px-2 py-0.5 rounded-full font-black italic bg-gray-700 text-gray-400 text-xs transition-all duration-300">1x</div>
                    </div>

                    <div class="flex items-center gap-2">
                        <span id="game-info-right" class="text-sm font-bold text-gray-400">0</span>
                        <button onclick="app.showHint()" class="w-6 h-6 rounded-full bg-gray-700 hover:bg-indigo-600 text-white text-xs font-bold flex items-center justify-center transition" title="Show Hint">?</button>
                    </div>
                </header>

                <!-- Timer Bar -->
                <div id="timer-container" class="hidden absolute top-0 left-0 w-full h-1.5 bg-gray-700 z-0">
                    <div id="timer-bar" class="h-full bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.5)] transition-all duration-1000 ease-linear" style="width: 100%"></div>
                </div>

                <!-- Problem Area -->
                <div class="flex-grow flex flex-col items-center justify-center py-2 relative">
                    <div id="problem-area" class="text-center w-full transition-all duration-200">
                        <!-- Content Injected via JS -->
                    </div>
                    
                    <!-- Hint Overlay -->
                    <div id="hint-box" class="hidden absolute inset-0 hint-overlay rounded-lg flex items-center justify-center p-4 text-center z-20 flex-col">
                        <div class="text-indigo-400 font-bold mb-2">HINT</div>
                        <p id="hint-text" class="text-sm text-gray-300"></p>
                        <button onclick="app.hideHint()" class="mt-4 text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Close</button>
                    </div>
                </div>

                <!-- Feedback Area -->
                <div id="feedback-bar" class="hidden text-center text-sm font-bold p-2 rounded mb-2"></div>

                <!-- Controls Container -->
                <div id="controls-area" class="mt-2">
                    
                    <!-- 1. Text Input (Standard) -->
                    <form id="answer-form" class="w-full" autocomplete="off">
                        <input type="text" id="answer-input" inputmode="numeric" pattern="[0-9.-]*"
                               class="w-full text-center text-4xl font-bold p-4 rounded-xl bg-gray-900 text-white border-2 border-gray-700 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 outline-none transition duration-200 placeholder-gray-800 font-mono"
                               placeholder="?" required>
                        <button type="submit" id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg transition duration-200 mt-4 active:scale-[0.98]">
                            Submit
                        </button>
                    </form>

                    <!-- 2. Boolean Inputs (Is Prime) -->
                    <div id="bool-controls" class="hidden grid grid-cols-2 gap-4">
                        <button onclick="app.submitBoolean(true)" class="bg-green-700 hover:bg-green-600 border-b-4 border-green-900 hover:border-green-800 text-white font-bold py-6 rounded-xl text-xl transition active:translate-y-1 active:border-b-0">
                            YES
                        </button>
                        <button onclick="app.submitBoolean(false)" class="bg-red-700 hover:bg-red-600 border-b-4 border-red-900 hover:border-red-800 text-white font-bold py-6 rounded-xl text-xl transition active:translate-y-1 active:border-b-0">
                            NO
                        </button>
                    </div>

                    <!-- 3. Binary Submit (Write Binary) -->
                    <button id="binary-submit-btn" onclick="app.submitBinary()" class="hidden w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg transition duration-200 active:scale-[0.98]">
                        Confirm Pattern
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: RESULTS -->
        <div id="results-view" class="hidden w-full text-center max-w-md fade-enter-active">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl border border-gray-700 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/10 to-transparent pointer-events-none"></div>
                
                <h2 class="text-3xl font-bold text-white mb-2 relative z-10">Time's Up!</h2>
                
                <div class="my-8 relative z-10">
                    <div class="text-gray-400 text-sm uppercase tracking-wide mb-1">Final Score</div>
                    <div class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-400" id="final-score">0</div>
                    <div id="new-pb-badge" class="hidden mt-2 inline-block bg-yellow-500/20 text-yellow-300 border border-yellow-500/50 px-3 py-1 rounded-full text-xs font-bold">
                        üéâ NEW PERSONAL BEST
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8 relative z-10">
                    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                        <div class="text-xs text-gray-500">Problems</div>
                        <div class="text-xl font-bold text-white" id="result-count">0</div>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                        <div class="text-xs text-gray-500">Best Streak</div>
                        <div class="text-xl font-bold text-white" id="result-streak">0</div>
                    </div>
                </div>

                <button onclick="app.startTimed()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition mb-3 shadow-lg shadow-indigo-500/20">Try Again</button>
                <button onclick="app.goHome()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 rounded-lg transition">Main Menu</button>
            </div>
        </div>

    </main>
    
    <!-- MODAL: History -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-filter blur-sm" onclick="app.toggleHistory()"></div>
        <div class="bg-gray-800 rounded-xl p-6 max-w-sm w-full relative z-10 shadow-2xl border border-gray-700 flex flex-col max-h-[80vh]">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center justify-between">
                Last 10 Runs
                <button onclick="app.toggleHistory()" class="text-gray-500 hover:text-white">&times;</button>
            </h3>
            <div id="history-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 pr-1">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        
        const PRIMES = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151];

        const Random = {
            int: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            from: (arr) => arr[Math.floor(Math.random() * arr.length)],
            bool: () => Math.random() > 0.5,
            weighted: (arr, weights) => {
                let sum = weights.reduce((acc, el) => acc + el, 0);
                let acc = 0;
                let chance = Math.random() * sum;
                for (let i = 0; i < arr.length; i++) {
                    acc += weights[i];
                    if (chance <= acc) return arr[i];
                }
                return arr[0];
            }
        };

        // --- CORE APP ---

        class MentalMathApp {
            constructor() {
                // Persistent Data
                this.history = JSON.parse(localStorage.getItem('mm_history')) || [];
                this.pb = parseInt(localStorage.getItem('mm_pb')) || 0;
                this.career = JSON.parse(localStorage.getItem('mm_career')) || { level: 1, streak: 0 };

                // Runtime State
                this.state = {
                    mode: 'MENU', 
                    level: 1,
                    score: 0,
                    rawSolved: 0,
                    streak: 0,
                    maxStreak: 0,
                    multiplier: 1,
                    timeLeft: 0,
                    problem: null, // { html, answer, type, hint, id }
                    isSubmitting: false,
                    binaryValue: 0,
                    recentProblems: []
                };

                this.timerInterval = null;

                // DOM Elements
                this.el = {
                    views: {
                        menu: document.getElementById('menu-view'),
                        practice: document.getElementById('practice-view'),
                        game: document.getElementById('game-view'),
                        results: document.getElementById('results-view')
                    },
                    game: {
                        area: document.getElementById('problem-area'),
                        input: document.getElementById('answer-input'),
                        form: document.getElementById('answer-form'),
                        infoLeft: document.getElementById('game-info-left'),
                        infoRight: document.getElementById('game-info-right'),
                        feedback: document.getElementById('feedback-bar'),
                        timerBar: document.getElementById('timer-bar'),
                        timerCont: document.getElementById('timer-container'),
                        multiplier: document.getElementById('multiplier-badge'),
                        boolControls: document.getElementById('bool-controls'),
                        binSubmit: document.getElementById('binary-submit-btn'),
                        hintBox: document.getElementById('hint-box'),
                        hintText: document.getElementById('hint-text')
                    },
                    results: {
                        score: document.getElementById('final-score'),
                        count: document.getElementById('result-count'),
                        streak: document.getElementById('result-streak'),
                        badge: document.getElementById('new-pb-badge')
                    },
                    modals: {
                        history: document.getElementById('history-modal')
                    }
                };

                // Initialization
                this.updateMenuPB();
                this.bindEvents();
            }

            bindEvents() {
                this.el.game.form.addEventListener('submit', (e) => this.handleSubmit(e));
                document.getElementById('exit-btn').addEventListener('click', () => this.goHome());

                // Interactive bits (Event Delegation for Binary Write)
                this.el.game.area.addEventListener('click', (e) => {
                    const btn = e.target.closest('.bit-interactive');
                    if (btn && !this.state.isSubmitting) this.toggleBit(btn);
                });
            }

            // --- VIEW MANAGEMENT ---

            switchView(name) {
                Object.values(this.el.views).forEach(el => el.classList.add('hidden'));
                document.getElementById('exit-btn').classList.add('hidden');
                
                if (name === 'GAME') {
                    this.el.views.game.classList.remove('hidden');
                    document.getElementById('exit-btn').classList.remove('hidden');
                } else if (name === 'MENU') {
                    this.el.views.menu.classList.remove('hidden');
                } else if (name === 'PRACTICE') {
                    this.el.views.practice.classList.remove('hidden');
                } else if (name === 'RESULTS') {
                    this.el.views.results.classList.remove('hidden');
                }
            }

            updateMenuPB() {
                document.getElementById('menu-pb').textContent = `PB: ${this.pb}`;
            }

            goHome() {
                clearInterval(this.timerInterval);
                this.state.mode = 'MENU';
                this.switchView('MENU');
            }

            showPracticeMenu() { this.switchView('PRACTICE'); }

            toggleHistory() {
                const modal = this.el.modals.history;
                if (modal.classList.contains('hidden')) {
                    const list = document.getElementById('history-list');
                    if (this.history.length === 0) {
                        list.innerHTML = '<div class="text-gray-500 text-center text-sm py-4">No history yet.</div>';
                    } else {
                        list.innerHTML = this.history.map(h => `
                            <div class="flex justify-between items-center bg-gray-900/50 p-3 rounded border border-gray-700">
                                <span class="text-gray-400 text-xs">${h.date}</span>
                                <span class="font-mono font-bold text-indigo-400">${h.score} pts</span>
                            </div>
                        `).join('');
                    }
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }
            
            showHint() {
                const hint = this.state.problem.hint || "No hint available.";
                this.el.game.hintText.textContent = hint;
                this.el.game.hintBox.classList.remove('hidden');
            }
            
            hideHint() {
                this.el.game.hintBox.classList.add('hidden');
            }

            // --- GAME MODES ---

            startCareer() {
                this.state = { ...this.state, mode: 'CAREER', level: this.career.level, streak: this.career.streak, score: 0 };
                this.el.game.timerCont.classList.add('hidden');
                this.el.game.multiplier.classList.add('hidden');
                this.startRound();
            }

            startPractice(lvl) {
                this.state = { ...this.state, mode: 'PRACTICE', level: lvl, streak: 0, score: 0 };
                this.el.game.timerCont.classList.add('hidden');
                this.el.game.multiplier.classList.add('hidden');
                this.startRound();
            }

            startTimed() {
                this.state = { 
                    ...this.state, 
                    mode: 'TIMED', 
                    level: 1, 
                    score: 0, 
                    rawSolved: 0,
                    streak: 0, 
                    multiplier: 1, 
                    timeLeft: 300, 
                    recentProblems: []
                };
                
                this.el.game.timerCont.classList.remove('hidden');
                this.el.game.multiplier.classList.remove('hidden');
                this.startRound();

                this.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    const pct = (this.state.timeLeft / 300) * 100;
                    this.el.game.timerBar.style.width = `${pct}%`;
                    
                    if (pct < 20) this.el.game.timerBar.className = 'h-full bg-red-500 transition-all duration-1000 linear shadow-[0_0_15px_red]';
                    
                    if (this.state.timeLeft <= 0) this.endTimedMode();
                }, 1000);
            }

            // --- GAME LOOP ---

            startRound() {
                this.switchView('GAME');
                this.hideHint();
                
                // Dynamic Difficulty for Timed Mode
                if (this.state.mode === 'TIMED') {
                    this.state.level = this.getDynamicLevel();
                }

                // Generate Problem
                let problem, id;
                let attempts = 0;
                do {
                    problem = this.generateProblem(this.state.level);
                    id = problem.id;
                    attempts++;
                } while (this.state.recentProblems.includes(id) && attempts < 5);

                this.state.recentProblems.push(id);
                if (this.state.recentProblems.length > 30) this.state.recentProblems.shift();

                this.state.problem = problem;
                this.el.game.area.innerHTML = problem.html;

                this.resetInputUI(); // Sets up correct inputs (text vs buttons vs switches)
                this.updateGameHeader();
            }

            getDynamicLevel() {
                const s = this.state.score;
                if (s < 50) return Random.weighted([1, 2, 3], [40, 40, 20]);
                if (s < 150) return Random.weighted([3, 4, 5, 6, 8], [20, 20, 20, 20, 20]);
                if (s < 300) return Random.weighted([5, 7, 8, 9, 10], [15, 15, 20, 25, 25]);
                return Random.weighted([9, 10], [30, 70]);
            }

            updateGameHeader() {
                if (this.state.mode === 'TIMED') {
                    const m = Math.floor(this.state.timeLeft / 60);
                    const s = this.state.timeLeft % 60;
                    this.el.game.infoLeft.textContent = `${m}:${s.toString().padStart(2,'0')}`;
                    
                    this.updateMultiplier();
                    this.el.game.infoRight.textContent = this.state.score;
                    this.el.game.infoRight.classList.add('text-indigo-400', 'text-xl');
                } else {
                    let name = `Level ${this.state.level}`;
                    if (this.state.level === 8) name = "Modulo %";
                    if (this.state.level === 9) name = "Primes";
                    if (this.state.level === 10) name = "CHAOS";
                    this.el.game.infoLeft.textContent = name;
                    this.el.game.infoRight.textContent = `Streak: ${this.state.streak}`;
                }
            }

            updateMultiplier() {
                const s = this.state.streak;
                let m = 1;
                let color = "bg-gray-700 text-gray-400";
                
                if (s >= 5) { m = 2; color = "bg-blue-600 text-white shadow-[0_0_10px_#2563eb]"; }
                if (s >= 15) { m = 3; color = "bg-purple-600 text-white shadow-[0_0_15px_#9333ea]"; }
                if (s >= 30) { m = 5; color = "bg-orange-500 text-white shadow-[0_0_20px_#f97316] multiplier-pulse"; }

                this.state.multiplier = m;
                const badge = this.el.game.multiplier;
                badge.className = `px-2 py-0.5 rounded-full font-black italic text-xs transition-all duration-300 ${color}`;
                badge.textContent = `${m}x`;
            }

            resetInputUI() {
                this.state.isSubmitting = false;
                this.el.game.feedback.classList.add('hidden');
                
                // Hide all input types first
                this.el.game.form.classList.add('hidden');
                this.el.game.boolControls.classList.add('hidden');
                this.el.game.binSubmit.classList.add('hidden');
                
                const type = this.state.problem.type;

                if (type === 'binary_write') {
                    // Show Binary Confirm Button
                    this.el.game.binSubmit.classList.remove('hidden');
                    this.state.binaryValue = 0; // Reset internal counter
                } 
                else if (type === 'boolean') {
                    // Show Yes/No Buttons
                    this.el.game.boolControls.classList.remove('hidden');
                } 
                else {
                    // Standard Text Input
                    this.el.game.form.classList.remove('hidden');
                    this.el.game.input.value = '';
                    this.el.game.input.disabled = false;
                    setTimeout(() => this.el.game.input.focus(), 50);
                }
            }

            // --- INTERACTION ---

            toggleBit(btn) {
                const val = parseInt(btn.dataset.power);
                const isOn = btn.classList.contains('bit-on');
                
                if (isOn) {
                    btn.classList.replace('bit-on', 'bit-off');
                    btn.textContent = '0';
                    this.state.binaryValue -= val;
                } else {
                    btn.classList.replace('bit-off', 'bit-on');
                    btn.textContent = '1';
                    this.state.binaryValue += val;
                }
            }

            // Handler for Standard Input
            handleSubmit(e) {
                e.preventDefault();
                if (this.state.isSubmitting) return;
                const userVal = this.el.game.input.value.trim().toLowerCase();
                const correctVal = this.state.problem.answer.toString().toLowerCase();
                this.handleResult(userVal === correctVal);
            }

            // Handler for Yes/No
            submitBoolean(val) {
                if (this.state.isSubmitting) return;
                this.handleResult(val === this.state.problem.answer);
            }

            // Handler for Binary Write
            submitBinary() {
                if (this.state.isSubmitting) return;
                this.handleResult(this.state.binaryValue === this.state.problem.answer);
            }

            handleResult(isCorrect) {
                this.state.isSubmitting = true;
                this.el.game.input.disabled = true;
                
                const fb = this.el.game.feedback;
                fb.classList.remove('hidden', 'bg-red-900', 'text-red-200', 'bg-green-900', 'text-green-200');

                if (isCorrect) {
                    const basePoints = 10; 
                    const points = basePoints * this.state.multiplier;
                    this.state.streak++;
                    if(this.state.streak > this.state.maxStreak) this.state.maxStreak = this.state.streak;
                    
                    if (this.state.mode === 'TIMED') {
                        this.state.score += points;
                        this.state.rawSolved++;
                    }

                    if (this.state.mode === 'CAREER') {
                        this.career.streak = this.state.streak;
                        if (this.career.streak >= 5) {
                            this.career.streak = 0;
                            this.career.level++;
                            this.state.streak = 0;
                            this.state.level++;
                            if (this.state.level > 10) this.state.level = 1; 
                            this.career.level = this.state.level;
                        }
                        localStorage.setItem('mm_career', JSON.stringify(this.career));
                    }

                    fb.textContent = (this.state.mode === 'TIMED') ? `Correct! +${points}` : "Correct!";
                    fb.classList.add('bg-green-900', 'text-green-200');

                } else {
                    this.state.streak = 0;
                    if (this.state.mode === 'CAREER') {
                        this.career.streak = 0;
                        localStorage.setItem('mm_career', JSON.stringify(this.career));
                    }
                    
                    let disp = this.state.problem.answer;
                    if(this.state.problem.type === 'boolean') disp = disp ? "YES" : "NO";
                    
                    fb.innerHTML = `Wrong. Answer: <span class="font-mono bg-black/20 px-1 rounded">${disp}</span>`;
                    fb.classList.add('bg-red-900', 'text-red-200');
                }

                setTimeout(() => {
                    this.startRound();
                }, isCorrect ? 600 : 2000);
            }

            endTimedMode() {
                clearInterval(this.timerInterval);
                const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                this.history.unshift({ date, score: this.state.score });
                if (this.history.length > 10) this.history.pop();
                localStorage.setItem('mm_history', JSON.stringify(this.history));

                const isPB = this.state.score > this.pb;
                if (isPB) {
                    this.pb = this.state.score;
                    localStorage.setItem('mm_pb', this.pb);
                    this.updateMenuPB();
                }

                this.el.results.score.textContent = this.state.score;
                this.el.results.count.textContent = this.state.rawSolved;
                this.el.results.streak.textContent = this.state.maxStreak;
                
                if (isPB) this.el.results.badge.classList.remove('hidden');
                else this.el.results.badge.classList.add('hidden');

                this.switchView('RESULTS');
            }

            // --- PROBLEM GENERATOR ENGINE ---

            generateProblem(level) {
                const r = Random;
                let html = '', answer = 0, id = '', type = 'standard', hint = '';
                const m = (txt) => `<span class="font-mono font-bold">${txt}</span>`;

                switch(level) {
                    case 1: // Arithmetic
                        {
                            const op = r.from(['+', '-', '*', '/']);
                            if(op==='+'){ const a=r.int(10,99), b=r.int(10,99); answer=a+b; html=`${m(a)} + ${m(b)}`; id=`l1_add_${a}_${b}`; hint="Add the tens first, then the ones."; }
                            if(op==='-'){ const a=r.int(20,99), b=r.int(5,a-5); answer=a-b; html=`${m(a)} - ${m(b)}`; id=`l1_sub_${a}_${b}`; hint="Subtract tens, then ones."; }
                            if(op==='*'){ const a=r.int(2,12), b=r.int(2,12); answer=a*b; html=`${m(a)} &times; ${m(b)}`; id=`l1_mul_${a}_${b}`; hint="Recall your multiplication tables."; }
                            if(op==='/'){ const ans=r.int(2,12), b=r.int(2,12); const a=ans*b; answer=ans; html=`${m(a)} &div; ${m(b)}`; id=`l1_div_${a}_${b}`; hint="Multiplication in reverse. What number times " + b + " equals " + a + "?"; }
                        } break;
                    case 2: // Complex
                        {
                            const type = r.int(1,2);
                            if(type===1){ 
                                const b=r.int(4,12), sub=r.int(5,20); answer=b*b-sub; html=`${m(b)}¬≤ - ${m(sub)}`; id=`l2_sq_${b}_${sub}`; 
                                hint=`${b} times ${b} is ${b*b}. Subtract ${sub}.`;
                            } else { 
                                const a=r.int(2,8), b=r.int(2,8), c=r.int(2,5); answer=(a+b)*c; html=`(${m(a)} + ${m(b)}) &times; ${m(c)}`; id=`l2_mix_${a}_${b}_${c}`; 
                                hint=`Do the brackets first: ${a+b}. Then multiply by ${c}.`;
                            }
                        } break;
                    case 3: // Fractions/Pct
                        {
                            if(r.bool()) {
                                const p=r.from([10,20,25,50]); const v=r.int(2,10)*20; answer=(p/100)*v; 
                                html=`${m(p)}% of ${m(v)}`; id=`l3_pct_${p}_${v}`;
                                if(p===50) hint="Divide by 2."; else if(p===25) hint="Divide by 4."; else if(p===10) hint="Divide by 10 (remove zero)."; else hint="Divide by 10, then multiply by 2.";
                            } else {
                                const d=r.from([2,3,4,5]); const n=r.int(1,d-1); const v=r.int(2,12)*d; answer=(n/d)*v;
                                html=`<sup>${n}</sup>&frasl;<sub>${d}</sub> of ${m(v)}`; id=`l3_frac_${n}_${d}_${v}`;
                                hint=`Divide ${v} by ${d}, then multiply the result by ${n}.`;
                            }
                        } break;
                    case 4: // Algebra
                        {
                            const x=r.int(2,12), a=r.int(2,9), b=r.int(1,15); const c=a*x-b;
                            html=`<div class="text-3xl">${m(a)}x - ${m(b)} = ${m(c)}</div><div class="mt-2 text-indigo-400 text-sm">x = ?</div>`;
                            answer=x; id=`l4_alg_${a}_${b}_${c}`;
                            hint=`Add ${b} to ${c}, then divide by ${a}.`;
                        } break;
                    case 5: // Sequences
                        {
                            const s=r.int(1,20), step=r.int(2,10); answer=s+step*4;
                            html=`${m(s)}, ${m(s+step)}, ${m(s+step*2)}, ${m(s+step*3)}, <span class="text-indigo-400">?</span>`;
                            id=`l5_seq_${s}_${step}`;
                            hint=`The numbers increase by ${step} each time.`;
                        } break;
                    case 6: // Read Binary
                        {
                            const bits=r.weighted([4,5,6],[50,30,20]); answer=r.int(1, Math.pow(2,bits)-1);
                            const binStr = answer.toString(2).padStart(bits,'0');
                            html = `<div class="text-xs text-gray-500 mb-4">CONVERT TO DECIMAL</div>` + this.renderBinarySwitches(binStr, bits, false);
                            id=`l6_bin_${answer}`;
                            hint="Add up the numbers under the switches that are ON (1). Values are 1, 2, 4, 8, 16, 32 from right to left.";
                        } break;
                    case 7: // Write Binary
                        {
                            const bits=r.weighted([4,5],[60,40]); const val=r.int(1, Math.pow(2,bits)-1);
                            answer=val;
                            html = `<div class="text-xs text-gray-500 mb-2">MAKE THIS NUMBER:</div>
                                    <div class="text-5xl font-mono font-bold text-indigo-400 mb-6">${val}</div>
                                    ${this.renderBinarySwitches("0".repeat(bits), bits, true)}`;
                            id=`l7_binw_${val}`;
                            type = 'binary_write';
                            hint="Toggle switches (ON/1) until their values sum up to the target number. Start with the largest number that fits.";
                        } break;
                    case 8: // Modulo
                        {
                            const d=r.int(3,12); const mul=r.int(2,10); const rem=r.int(1,d-1);
                            const num = (d*mul) + rem;
                            html=`${m(num)} % ${m(d)}`; answer=rem; id=`l8_mod_${num}_${d}`;
                            hint=`What is the remainder when you divide ${num} by ${d}?`;
                        } break;
                    case 9: // Is it Prime? (Boolean)
                        {
                            let num;
                            const isPrime = r.bool();
                            if(isPrime) {
                                num = Random.from(PRIMES);
                            } else {
                                // Generate composite
                                do { num = r.int(4, 150); } while(PRIMES.includes(num));
                            }
                            answer = isPrime;
                            html = `<div class="text-sm text-gray-400 mb-2">IS THIS PRIME?</div><div class="text-6xl font-mono font-bold">${num}</div>`;
                            id=`l9_prime_${num}`;
                            type = 'boolean';
                            hint=`A prime number is only divisible by 1 and itself. Try dividing by 2, 3, 5, 7.`;
                        } break;
                    case 10: // CHAOS MODE
                        {
                            const chaosType = r.int(1,2);
                            if(chaosType === 1) { // Binary + Decimal Addition
                                const valBin = r.int(1, 15);
                                const valDec = r.int(5, 50);
                                const binStr = valBin.toString(2);
                                html = `<div class="flex items-center justify-center gap-4 text-3xl chaos-text">
                                            <span class="font-mono text-green-400">${binStr}<sub class="text-xs">2</sub></span> 
                                            <span>+</span> 
                                            <span class="font-mono">${valDec}</span>
                                        </div>`;
                                answer = valBin + valDec;
                                id = `l10_chaos_add_${valBin}_${valDec}`;
                                hint = `Convert ${binStr} (base 2) to decimal first, then add.`;
                            } else { // Binary - Decimal
                                const valBin = r.int(8, 31);
                                const valDec = r.int(1, 7);
                                const binStr = valBin.toString(2);
                                html = `<div class="flex items-center justify-center gap-4 text-3xl chaos-text">
                                            <span class="font-mono text-green-400">${binStr}<sub class="text-xs">2</sub></span> 
                                            <span>-</span> 
                                            <span class="font-mono">${valDec}</span>
                                        </div>`;
                                answer = valBin - valDec;
                                id = `l10_chaos_sub_${valBin}_${valDec}`;
                                hint = `Convert ${binStr} (base 2) to decimal first, then subtract.`;
                            }
                            document.body.classList.add('chaos-active');
                            setTimeout(() => document.body.classList.remove('chaos-active'), 500);
                        } break;
                }

                if(!html.includes('div') && !html.includes('span')) html = `<span class="text-5xl">${html}</span>`;
                else if(!html.includes('text-')) html = `<div class="text-5xl">${html}</div>`;
                
                return { html, answer, id, type, hint };
            }

            renderBinarySwitches(binStr, count, interactive) {
                let h = '<div class="flex justify-center gap-2 flex-wrap">';
                for(let i=0; i<count; i++) {
                    const power = Math.pow(2, count - 1 - i);
                    const isOn = binStr[i] === '1';
                    const cls = isOn ? 'bit-on' : 'bit-off';
                    const interact = interactive ? 'bit-interactive cursor-pointer hover:scale-105' : '';
                    h += `
                        <div class="flex flex-col items-center">
                            <div data-power="${power}" class="w-10 h-14 rounded border-2 flex items-center justify-center font-mono text-xl font-bold mb-1 bit-switch ${cls} ${interact}">
                                ${isOn ? '1' : '0'}
                            </div>
                            <span class="text-[10px] text-indigo-400 font-mono hint-text">${power}</span>
                        </div>`;
                }
                return h + '</div>';
            }
        }

        const app = new MentalMathApp();
        window.app = app;

        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(console.log);
            else document.exitFullscreen();
        });
    </script>
</body>
</html>